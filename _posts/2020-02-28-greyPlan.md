---
layout:     post
title:      ä¸€ä¸ªç®€å•çš„ç°åº¦æ–¹æ¡ˆè®¾è®¡
subtitle:   ç®€ç®€å•å•å†™ä¸€ä¸ªç®€ç®€å•å•çš„ç°åº¦æ–¹æ¡ˆï¼Œç„¶åå‘ç°è‡ªå·±çœŸçš„ä¸ä¼šå†™æ–‡æ¡£ğŸ˜­
date:       2020-02-28
author:     zhi
header-img: img/2020022802_bg.gif
catalog: true
tags:
    - LIFE
    - çå˜šå˜š
---


## æ¦‚è¿°

ç°åº¦æ–¹æ¡ˆæ˜¯ä¸€ç§è®©å¼€å‘åœ¨é»‘ç™½ä¹‹é—´å¹³æ»‘è¿‡åº¦çš„ä¸€ç§å‘å¸ƒæ–¹æ¡ˆï¼Œè®©éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨ç¨³å®šçš„æ—§æ–¹æ¡ˆï¼Œè®©å¦ä¸€éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨æ–°æ–¹æ¡ˆï¼Œå¦‚æœå¯¹äºæ–°æ–¹æ¡ˆæ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆå°±æŠŠç°åº¦å¼€å…³å¼€åˆ°æœ€å¤§ä½¿ç”¨æ–°é€»è¾‘ã€‚ç°åº¦æ–¹æ¡ˆå¯ä»¥æ•´ä½“ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç°åº¦æœŸé—´å‘ç°é—®é¢˜ã€è§£å†³é—®é¢˜ã€è°ƒæ•´é—®é¢˜ï¼Œé™ä½å‡ºç°é—®é¢˜çš„æŸå¤±ï¼Œä¿è¯ä¸Šçº¿è¿›åº¦ã€‚


## å®ç°æ€è·¯
å¤§ä½“å®ç°é€»è¾‘
![699e59b86191ecb2212b062776a52550.png](evernotecid://B6D2603C-2349-47FA-A4DE-C3AEAB1D501D/appyinxiangcom/12798685/ENResource/p336)

æœ¬æ–¹æ¡ˆç°åº¦é€»è¾‘å®ç°åœ¨ä»£ç å±‚é¢

## å…·ä½“å®ç°

![image](https://inews.gtimg.com/newsapp_bt/0/8956641362/640)

åºŸè¯ä¸å¤šè¯´ ç›´æ¥è´´ä»£ç 

### DB è®¾è®¡

è¡¨ä¸»è¦æ¶µç›–ç°åº¦idã€ç°åº¦åç§°ã€ç°åº¦å¼€å…³ã€ç™½åå•ã€é»‘åå•ã€ç°åº¦åŒºé—´å‡ ä¸ªå­—æ®µ

- ç°åº¦åç§° å£°æ˜è¯¥ç°åº¦æ˜¯å¹²å˜›åœ°
- ç°åº¦å¼€å…³ å¯ä»¥ç›´æ¥å…³é—­ç°åº¦å¼€å…³èµ°æ—§é€»è¾‘ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å…³é—­ç°åº¦èµ°æ–°é€»è¾‘
- ç™½åå• ç”¨â€˜,â€™ åˆ†å‰²çš„å­—ç¬¦ä¸²ï¼Œç›´æ¥èµ°æ–°é€»è¾‘çš„ä¸€éƒ¨åˆ†id
- é»‘åå• ç”¨â€˜.â€™ åˆ†å‰²çš„å­—ç¬¦ä¸²ï¼Œç›´æ¥èµ°å°±é€»è¾‘çš„ä¸€éƒ¨åˆ†id
- ç°åº¦åŒºé—´ ç”¨â€˜,â€™ åˆ†å‰²çš„å­—ç¬¦ä¸²ï¼Œ ç±»ä¼¼ '20,80' æ„å‘³ç€idå°¾æ•°è½åœ¨è¯¥åŒºé—´å†…å°±æ˜¯èµ°æ–°é€»è¾‘

å…·ä½“çš„è¡¨ç»“æ„å¦‚ä¸‹

```SQL
-- auto-generated definition
create table gray_feature
(
    id            int auto_increment comment 'ä¸»é”®id'
        primary key,
    gray_id       int                                   null comment 'ç°åº¦id',
    gray_name     varchar(32) default ''                not null comment 'ç°åº¦åç§°',
    gray_switch   tinyint     default 1                 null comment '0 ç°åº¦å…³é—­ ç›´æ¥è¿”å›false èµ°è€é€»è¾‘
1 ç°åº¦å¼€å¯ è¿›å…¥ç°åº¦åˆ¤æ–­
2 ç°åº¦å…³é—­ ç›´æ¥è¿”å›true èµ°æ–°é€»è¾‘',
    white_list    varchar(64) default ''                not null comment 'ç™½åå•',
    black_list    varchar(64) default ''                not null comment 'é»‘åå• ä¼˜å…ˆçº§é«˜äºç™½åå•',
    gray_interval varchar(64) default '0,1'             not null comment 'ç°åº¦åŒºé—´ å·¦é—­å³å¼€',
    create_time   datetime    default CURRENT_TIMESTAMP null comment 'åˆ›å»ºæ—¶é—´',
    constraint gray_feature_gray_id_uindex
        unique (gray_id)
)
    comment 'ç°åº¦ç‰¹æ€§';

```

### ä»£ç é€»è¾‘è®¾è®¡

å› ä¸ºæ˜¯ä¸ªç®€å•çš„ç°åº¦é€»è¾‘ï¼Œä¸»è¦ç”¨äºåå°å¼€å‘ä¸€äº›é‡æ„ã€è¿ç§»é¡¹ç›®åˆšä¸Šçº¿é˜²æ­¢å‡ºé—®é¢˜çš„ç®€æ˜“ç­–ç•¥ï¼Œå› æ­¤æ— è®ºè¶Šç®€å•è¶Šå¥½ï¼Œå“åº”è¶Šå¿«è¶Šå¥½ã€‚
ç°åº¦åˆ¤æ–­çš„æ ¸å¿ƒå°±æ˜¯ä»DBæ‹¿åˆ°ç°åº¦é…ç½®ï¼Œç„¶åå»æ ¡éªŒå¯¹åº”çš„idï¼Œä¸ºäº†å“åº”è¶³å¤Ÿå¿«ï¼Œè¿™é‡ŒæŠŠç°åº¦é…ç½®ç¼“å­˜åœ¨å†…å­˜ä¸­ä¸€æ®µæ—¶é—´ã€‚ã€‚ã€‚ç›´æ¥è´´ä»£ç å§ã€‚ã€‚ã€‚

```java

/**
 * ç°åº¦ç›¸å…³
 *
 * @author zhi
 * @date 2020-02-28 12:50
 */
@Service
public class GrayServiceImpl implements GrayService {

    @Resource
    ApplicationContext context;

    /**
     * è·å–ç°åº¦ä¿¡æ¯
     *
     * @param grayId ç°åº¦id
     * @return ç°åº¦ä¿¡æ¯
     */
    private GrayFeatureDO getGrayFeature(Long grayId) {
        ILoadingCacheService<Long, GrayFeatureDO> grayFeatureCache = context.getBean("GRAY_FEATURE_CACHE", ILoadingCacheService.class);
        return grayFeatureCache.getValue(grayId);
    }

    @Override
    public boolean checkInGray(GrayCheckRequestVO requestVO) {

        if (null == requestVO || null == requestVO.getGrayId() || null == requestVO.getUid()) {
            return false;
        }

        GrayFeatureDO grayFeature = getGrayFeature(requestVO.getGrayId());
        if (grayFeature == null) {
            return false;
        }
        GrayFeatureDetail detail = convertGrayFeatureDetail(grayFeature);
        return checkGrayFeatureDetail(detail, requestVO.getUid());

    }


    private static final Function<String, List<String>> SPLIT_TO_LIST = str -> Splitter.on(",").omitEmptyStrings().splitToList(str);

    /**
     * ç°åº¦å¼€å…³å…³é—­
     */
    private static final int CLOSE_SWITCH = 0;

    /**
     * ç°åº¦å…³é—­ å…¨é‡true
     */
    private static final int TRUE_SWITCH = 2;

    private GrayFeatureDetail convertGrayFeatureDetail(GrayFeatureDO grayFeature) {

        GrayFeatureDetail grayFeatureDetail = new GrayFeatureDetail();

        grayFeatureDetail.setGrayId(grayFeature.getGrayId());
        grayFeatureDetail.setGrayName(grayFeature.getGrayName());
        grayFeatureDetail.setGraySwitch(grayFeature.getGraySwitch());

        List<Long> whiteList = SPLIT_TO_LIST.apply(grayFeature.getWhiteList()).stream().map(Long::new).collect(Collectors.toList());
        grayFeatureDetail.setWhiteList(whiteList);

        List<Long> blackList = SPLIT_TO_LIST.apply(grayFeature.getBlackList()).stream().map(Long::new).collect(Collectors.toList());
        grayFeatureDetail.setBlackList(blackList);

        String[] grayInterval = grayFeature.getGrayInterval().split(",");
        grayFeatureDetail.setGrayIntervalFloor(Integer.valueOf(grayInterval[0]));
        grayFeatureDetail.setGrayIntervalCell(Integer.valueOf(grayInterval[1]));
        grayFeatureDetail.setCreateTime(grayFeature.getCreateTime());

        return grayFeatureDetail;

    }

    private boolean checkGrayFeatureDetail(GrayFeatureDetail detail, Long uid) {
        if (uid == null) {
            return false;
        }
        // ç°åº¦å¼€å…³å…³é—­
        if (detail.getGraySwitch() == CLOSE_SWITCH) {
            return false;
        }
        // ç°åº¦å…¨é‡
        if (detail.getGraySwitch() == TRUE_SWITCH) {
            return true;
        }
        // é»‘åå•
        if (!CollectionUtils.isEmpty(detail.getBlackList()) && detail.getBlackList().contains(uid)) {
            return false;
        }
        // ç™½åå•
        if (!CollectionUtils.isEmpty(detail.getWhiteList()) && detail.getWhiteList().contains(uid)) {
            return true;
        }

        if (detail.getGrayIntervalCell() != null && detail.getGrayIntervalFloor() != null) {
            long mod = uid % 100;
            return detail.getGrayIntervalFloor() <= mod && mod < detail.getGrayIntervalCell();
        }

        return false;
    }
}

```
ç¼“å­˜è¿™å—çš„é€»è¾‘

```java
/**
 * ç¼“å­˜ç®¡ç†
 *
 * @author zhi
 * @date 2020-02-28 14:17
 */
@Configuration
@Slf4j
public class CacheConfig {

    @Bean(name = "grayFeatureCache")
    public Cache<Long, GrayFeatureDO> grayFeatureCache() {
        // è¿™é‡Œç”¨çš„æ˜¯ caffine ç¼“å­˜ä»–ä¸ª10åˆ†é’Ÿ ç¼“å­˜ä¹…äº† å°±ä¹ˆå¾—æ„ä¹‰äº†
        Cache<Long, GrayFeatureDO> grayFeatureCache = Caffeine.newBuilder().expireAfterWrite(600, TimeUnit.SECONDS).build();
        log.debug("è½½å…¥ grayFeatureCache");
        return grayFeatureCache;
    }
}

/**
 * ç¼“å­˜çš„å®ç°ç±» 
 * ILoadingCacheService å°±æ˜¯ä¸ªæ¥å£ æˆ‘å°±ä¸åˆ—å‡ºæ¥äº†
 * 
 * @author zhi
 * @date 2020-02-28 14:24
 */
@Service("GRAY_FEATURE_CACHE")
@Slf4j
public class GrayFeatureCacheImpl implements ILoadingCacheService<Long, GrayFeatureDO> {


    @Resource
    @Qualifier("grayFeatureCache")
    Cache<Long, GrayFeatureDO> grayFeatureCache;

    @Resource
    GrayDAO grayDAO;

    @Override
    public GrayFeatureDO getValue(Long grayId) {
        return grayFeatureCache.get(grayId, key -> grayDAO.getGrayFeatureByGrayId(key));
    }

    @Override
    public void clear() {

    }

    @Override
    public void saveValue(Long integer, GrayFeatureDO grayFeatureDO) {

    }

    @Override
    public long size() {
        return 0;
    }
}

```
    å°±æ­¤å°±å®Œæˆäº†æ‰€æœ‰ç°åº¦çš„é€»è¾‘ ç®€å•æ˜“æ‡‚

https://github.com/YinglishZhi/something/tree/master


# æœ¬äººçœŸçš„çœŸçš„ä¸å–„äºå†™æ–‡æ¡£ã€‚ã€‚ã€‚

